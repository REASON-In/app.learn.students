<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher - Start Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f9fafb;
    }
    header {
      background-color: #1e40af;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .container {
      padding: 20px;
    }
    button {
      background-color: #3b82f6;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background-color: #2563eb;
    }
    #videos {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .video-box {
      border: 2px solid #d1d5db;
      padding: 10px;
      border-radius: 10px;
      background-color: white;
      text-align: center;
      width: 250px;
    }
    .video-box video {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸŽ¥ Teacher Video Call Dashboard</h1>
  </header>
  <div class="container">
    <button id="startCallBtn">Start Call</button>
    <button id="endCallBtn" style="display: none; background-color: #ef4444;">End Call</button>
    <div id="videos"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAHSxenlPZD8veD-iZ6pJIOVRbuTD2dw0Q",
      authDomain: "learn-3f43b.firebaseapp.com",
      databaseURL: "https://learn-3f43b-default-rtdb.firebaseio.com",
      projectId: "learn-3f43b",
      storageBucket: "learn-3f43b.appspot.com",
      messagingSenderId: "54412751232",
      appId: "1:54412751232:web:31fe8e2f8b5cc03d409165",
      measurementId: "G-7HRKXL1EPS"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const startCallBtn = document.getElementById('startCallBtn');
    const endCallBtn = document.getElementById('endCallBtn');
    const videosDiv = document.getElementById('videos');

    let callId = null;
    let localStream = null;
    let peers = {};

    async function startCall() {
      callId = "call-" + Date.now();

      await db.ref('calls/' + callId).set({
        by: 'Teacher',
        startedAt: Date.now()
      });

      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        addVideoStream('ðŸ‘¨â€ðŸ« Me (Teacher)', localStream);

        db.ref('calls/' + callId + '/participants').on('child_added', snapshot => {
          const studentId = snapshot.key;
          if (studentId === 'teacher' || peers[studentId]) return;
          createPeerConnection(studentId);
        });

        db.ref('calls/' + callId + '/participants/teacher').set(true);
      } catch (e) {
        alert('Could not access camera/mic: ' + e.message);
      }

      startCallBtn.style.display = 'none';
      endCallBtn.style.display = 'inline-block';
    }

    function addVideoStream(name, stream) {
      const container = document.createElement('div');
      container.className = "video-box";

      const label = document.createElement('p');
      label.innerText = name;

      const video = document.createElement('video');
      video.autoplay = true;
      video.playsInline = true;
      video.srcObject = stream;

      container.appendChild(label);
      container.appendChild(video);
      videosDiv.appendChild(container);
    }

    async function createPeerConnection(studentId) {
      const peerConnection = new RTCPeerConnection();
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.ontrack = event => {
        if (!peers[studentId].remoteStream) {
          peers[studentId].remoteStream = new MediaStream();
          addVideoStream("ðŸ§‘ Student " + studentId, peers[studentId].remoteStream);
        }
        event.streams[0].getTracks().forEach(track => {
          peers[studentId].remoteStream.addTrack(track);
        });
      };

      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          db.ref(`calls/${callId}/iceCandidates/${studentId}/teacher`).push(event.candidate.toJSON());
        }
      };

      db.ref(`calls/${callId}/iceCandidates/${studentId}/student`).on('child_added', snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        peerConnection.addIceCandidate(candidate).catch(console.error);
      });

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      await db.ref(`calls/${callId}/offers/${studentId}`).set(offer.toJSON());

      db.ref(`calls/${callId}/answers/${studentId}`).on('value', async snapshot => {
        if (!snapshot.exists()) return;
        const answer = snapshot.val();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
      });

      peers[studentId] = { peerConnection };
    }

    function endCall() {
      // Stop media tracks
      localStream.getTracks().forEach(track => track.stop());

      // Close all peer connections
      Object.values(peers).forEach(p => p.peerConnection.close());

      // Remove call from Firebase
      db.ref('calls/' + callId).remove();

      // Reset UI
      videosDiv.innerHTML = '';
      startCallBtn.style.display = 'inline-block';
      endCallBtn.style.display = 'none';
    }

    startCallBtn.onclick = startCall;
    endCallBtn.onclick = endCall;
  </script>
</body>
</html>

