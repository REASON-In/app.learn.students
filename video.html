<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Video Call</title>
  <style>
    body {
      background: #f1f5f9;
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      padding: 20px;
    }
    video {
      border: 2px solid #1e3a8a;
      border-radius: 12px;
      width: 300px;
      height: 225px;
      object-fit: cover;
      background: black;
    }
  </style>
</head>
<body>
  <video id="localVideo" autoplay muted></video>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAHSxenlPZD8veD-iZ6pJIOVRbuTD2dw0Q",
      authDomain: "learn-3f43b.firebaseapp.com",
      databaseURL: "https://learn-3f43b-default-rtdb.firebaseio.com",
      projectId: "learn-3f43b",
      storageBucket: "learn-3f43b.appspot.com",
      messagingSenderId: "54412751232",
      appId: "1:54412751232:web:31fe8e2f8b5cc03d409165"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const callId = new URLSearchParams(location.search).get('callId');
    const localId = crypto.randomUUID(); // unique ID for each user
    const connections = {};
    let localStream;

    // Get camera + mic
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;
        document.getElementById("localVideo").srcObject = stream;

        // Announce yourself
        db.ref(`calls/${callId}/users/${localId}`).set(true);

        // Listen for new users
        db.ref(`calls/${callId}/users`).on("child_added", snapshot => {
          const remoteId = snapshot.key;
          if (remoteId !== localId && !connections[remoteId]) {
            startConnection(remoteId);
          }
        });

        // Cleanup when someone leaves
        window.addEventListener("beforeunload", () => {
          db.ref(`calls/${callId}/users/${localId}`).remove();
        });

      })
      .catch(err => {
        alert("Failed to get camera/mic. Please allow permissions.");
        console.error(err);
      });

    async function startConnection(remoteId) {
      const peer = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });
      connections[remoteId] = peer;

      // Add tracks
      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

      // ICE candidates
      peer.onicecandidate = event => {
        if (event.candidate) {
          db.ref(`calls/${callId}/signals/${remoteId}/${localId}/ice`).push(event.candidate.toJSON());
        }
      };

      // Remote stream
      peer.ontrack = event => {
        const remoteVideo = document.createElement("video");
        remoteVideo.autoplay = true;
        remoteVideo.srcObject = event.streams[0];
        document.body.appendChild(remoteVideo);
      };

      // Offer
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      db.ref(`calls/${callId}/signals/${remoteId}/${localId}/offer`).set(offer.toJSON());

      // Wait for answer
      db.ref(`calls/${callId}/signals/${localId}/${remoteId}/answer`).on("value", async snap => {
        const answer = snap.val();
        if (answer && !peer.currentRemoteDescription) {
          await peer.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      // ICE from other side
      db.ref(`calls/${callId}/signals/${localId}/${remoteId}/ice`).on("child_added", snap => {
        const candidate = new RTCIceCandidate(snap.val());
        peer.addIceCandidate(candidate);
      });

      // Wait for offer if other side started it first
      db.ref(`calls/${callId}/signals/${localId}/${remoteId}/offer`).on("value", async snap => {
        const offer = snap.val();
        if (offer && !peer.currentRemoteDescription) {
          await peer.setRemoteDescription(new RTCSessionDescription(offer));
          const answer = await peer.createAnswer();
          await peer.setLocalDescription(answer);
          db.ref(`calls/${callId}/signals/${remoteId}/${localId}/answer`).set(answer.toJSON());
        }
      });
    }
  </script>
</body>
</html>
