<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Study Timetable</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-purple-600 to-indigo-700 text-white min-h-screen flex flex-col items-center justify-center">
  <div class="bg-white text-gray-800 p-8 rounded-3xl shadow-lg max-w-6xl w-full">
    <h2 class="text-3xl font-bold text-center text-purple-700 mb-4">ðŸ“… Weekly Study Timetable</h2>
    <p class="text-center mb-6">Set subjects and time for each period (Monâ€“Fri).</p>
    <div class="overflow-auto">
      <table class="w-full table-auto text-sm">
        <thead>
          <tr class="bg-purple-200">
            <th class="p-2">Day</th>
            <th class="p-2">Period 1</th><th class="p-2">Time</th>
            <th class="p-2">Period 2</th><th class="p-2">Time</th>
            <th class="p-2">Period 3</th><th class="p-2">Time</th>
            <th class="p-2">Period 4</th><th class="p-2">Time</th>
            <th class="p-2">Period 5</th><th class="p-2">Time</th>
          </tr>
        </thead>
        <tbody id="timetableBody"></tbody>
      </table>
    </div>
    <div class="text-center mt-4">
      <button onclick="saveTimetable()" class="px-6 py-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition">Save Timetable</button>
    </div>
  </div>

  <script>
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    const periods = 5;
    const timetableBody = document.getElementById("timetableBody");

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentUser = null;

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loadTimetable();
      } else {
        firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
      }
    });

    function loadTimetable() {
      db.ref(`timetables/${currentUser.uid}`).once("value").then(snapshot => {
        const data = snapshot.val();
        generateInputs(data);
      });
    }

    function generateInputs(data) {
      timetableBody.innerHTML = "";
      days.forEach(day => {
        const row = document.createElement("tr");
        row.innerHTML = `<td class="p-2 font-bold">${day}</td>`;
        for (let p = 1; p <= periods; p++) {
          const subject = data?.[day]?.[`period${p}`]?.subject || "";
          const time = data?.[day]?.[`period${p}`]?.time || "";
          row.innerHTML += `
            <td class="p-2"><input id="${day}-p${p}-s" type="text" value="${subject}" class="border rounded p-1 w-full"></td>
            <td class="p-2"><input id="${day}-p${p}-t" type="text" value="${time}" class="border rounded p-1 w-full" placeholder="HH:MM AM/PM"></td>`;
        }
        timetableBody.appendChild(row);
      });
    }

    function parseTimeToDate(timeStr) {
      const [time, modifier] = timeStr.split(" ");
      if (!time || !modifier) return null;
      let [hours, minutes] = time.split(":").map(Number);
      if (modifier === "PM" && hours !== 12) hours += 12;
      if (modifier === "AM" && hours === 12) hours = 0;
      const now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
    }

    function saveTimetable() {
      const data = {};
      let valid = true;

      days.forEach(day => {
        const dayData = {};
        const timeArr = [];

        for (let p = 1; p <= periods; p++) {
          const subj = document.getElementById(`${day}-p${p}-s`).value.trim();
          const time = document.getElementById(`${day}-p${p}-t`).value.trim();
          if (!subj || !time) {
            alert(`Please complete all fields for ${day} Period ${p}`);
            valid = false;
            return;
          }
          dayData[`period${p}`] = { subject: subj, time };
          timeArr.push(time);
        }

        for (let i = 1; i < timeArr.length; i++) {
          const prev = parseTimeToDate(timeArr[i - 1]);
          const curr = parseTimeToDate(timeArr[i]);
          if (!prev || !curr || prev >= curr) {
            alert(`Periods on ${day} must be in chronological order.`);
            valid = false;
            return;
          }
        }

        data[day] = dayData;
      });

      if (!valid || !currentUser) return;

      db.ref(`timetables/${currentUser.uid}`).set(data).then(() => {
        alert("Timetable saved successfully!");
      });
    }
  </script>
</body>
</html>
