<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Timetable App with Firebase Auth</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 900px; }
    input[type="text"], input[type="time"], input[type="email"], input[type="password"] { padding: 5px; margin: 5px 0; }
    button { padding: 8px 12px; margin: 5px; cursor: pointer; }
    .day-container { border: 1px solid #ccc; margin-bottom: 15px; padding: 10px; }
    .period-row { margin-bottom: 8px; }
    label { margin-right: 10px; }
    #countdown { margin-top: 20px; font-size: 1.2em; font-weight: bold; }
    #login-section, #app-section { max-width: 600px; margin: auto; }
    #app-section { display: none; }
  </style>
</head>
<body>

  <div id="login-section">
    <h2>Login or Signup</h2>
    <input id="email" type="email" placeholder="Email" required /><br/>
    <input id="password" type="password" placeholder="Password" required /><br/>
    <button id="login-btn">Login</button>
    <button id="signup-btn">Sign Up</button>
    <div id="login-msg" style="color:red; margin-top:10px;"></div>
  </div>

  <div id="app-section">
    <h2>Welcome, <span id="user-email"></span></h2>
    <button id="logout-btn">Logout</button>

    <h3>Timetable (Monday to Friday)</h3>
    <button id="auto-fill-btn">Auto-Fill Default Timetable</button>
    <button id="save-btn">Save Timetable</button>
    <div id="validation-msg" style="color:red; margin:10px 0;"></div>

    <div id="timetable-container"></div>

    <div id="countdown">Loading countdown...</div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAHSxenlPZD8veD-iZ6pJIOVRbuTD2dw0Q",
      authDomain: "learn-3f43b.firebaseapp.com",
      databaseURL: "https://learn-3f43b-default-rtdb.firebaseio.com",
      projectId: "learn-3f43b",
      storageBucket: "learn-3f43b.firebasestorage.app",
      messagingSenderId: "54412751232",
      appId: "1:54412751232:web:31fe8e2f8b5cc03d409165",
      measurementId: "G-7HRKXL1EPS"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Elements
    const loginSection = document.getElementById('login-section');
    const appSection = document.getElementById('app-section');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userEmailSpan = document.getElementById('user-email');
    const autoFillBtn = document.getElementById('auto-fill-btn');
    const saveBtn = document.getElementById('save-btn');
    const timetableContainer = document.getElementById('timetable-container');
    const countdownDiv = document.getElementById('countdown');
    const loginMsg = document.getElementById('login-msg');
    const validationMsg = document.getElementById('validation-msg');

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    const periodCount = 4;

    let timetable = {}; // Will hold the timetable state
    let currentUser = null;
    let countdownInterval = null;

    // Default timetable for autofill
    const defaultPeriods = [
      { subject: 'Math', startTime: '09:00' },
      { subject: 'English', startTime: '10:00' },
      { subject: 'Science', startTime: '11:00' },
      { subject: 'History', startTime: '12:00' },
    ];

    // Auth state listener
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        userEmailSpan.textContent = user.email;
        loginSection.style.display = 'none';
        appSection.style.display = 'block';
        loadTimetable();
      } else {
        currentUser = null;
        userEmailSpan.textContent = '';
        loginSection.style.display = 'block';
        appSection.style.display = 'none';
        clearInterval(countdownInterval);
        countdownDiv.textContent = '';
        timetableContainer.innerHTML = '';
        timetable = {};
      }
    });

    // Signup handler
    signupBtn.onclick = () => {
      loginMsg.textContent = '';
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) {
        loginMsg.textContent = 'Email and password required!';
        return;
      }
      auth.createUserWithEmailAndPassword(email, password)
        .catch(e => loginMsg.textContent = 'Signup error: ' + e.message);
    };

    // Login handler
    loginBtn.onclick = () => {
      loginMsg.textContent = '';
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) {
        loginMsg.textContent = 'Email and password required!';
        return;
      }
      auth.signInWithEmailAndPassword(email, password)
        .catch(e => loginMsg.textContent = 'Login error: ' + e.message);
    };

    // Logout handler
    logoutBtn.onclick = () => {
      auth.signOut();
    };

    // Load timetable from Firebase DB
    function loadTimetable() {
      validationMsg.textContent = '';
      timetableContainer.innerHTML = 'Loading timetable...';
      database.ref(`users/${currentUser.uid}/timetable`).get()
        .then(snapshot => {
          if (snapshot.exists()) {
            timetable = snapshot.val();
          } else {
            timetable = {};
            days.forEach(day => {
              timetable[day] = JSON.parse(JSON.stringify(defaultPeriods));
            });
          }
          renderTimetable();
          startCountdown();
        })
        .catch(err => {
          timetableContainer.innerHTML = 'Error loading timetable: ' + err.message;
        });
    }

    // Render timetable inputs
    function renderTimetable() {
      timetableContainer.innerHTML = '';
      days.forEach(day => {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day-container';

        const dayTitle = document.createElement('h3');
        dayTitle.textContent = day;
        dayDiv.appendChild(dayTitle);

        timetable[day].forEach((period, i) => {
          const row = document.createElement('div');
          row.className = 'period-row';

          const subjLabel = document.createElement('label');
          subjLabel.textContent = `Period ${i+1} Subject: `;
          const subjInput = document.createElement('input');
          subjInput.type = 'text';
          subjInput.value = period.subject;
          subjInput.oninput = (e) => {
            timetable[day][i].subject = e.target.value;
          };

          const timeLabel = document.createElement('label');
          timeLabel.textContent = 'Start Time: ';
          const timeInput = document.createElement('input');
          timeInput.type = 'time';
          timeInput.value = period.startTime;
          timeInput.step = 60; // minute precision
          timeInput.oninput = (e) => {
            const val = e.target.value;
            if (!/^\d{2}:\d{2}$/.test(val)) return;
            const [h, m] = val.split(':').map(Number);
            if (h < 0 || h > 23 || m < 0 || m > 59) return;
            timetable[day][i].startTime = val;
          };

          row.appendChild(subjLabel);
          row.appendChild(subjInput);
          row.appendChild(timeLabel);
          row.appendChild(timeInput);
          dayDiv.appendChild(row);
        });

        timetableContainer.appendChild(dayDiv);
      });
    }

    // Validate timetable (period times ascending per day)
    function validateTimetable() {
      for (let day of days) {
        const periods = timetable[day];
        if (!periods || periods.length !== periodCount) return false;
        let lastMinutes = -1;
        for (let p of periods) {
          const [h, m] = p.startTime.split(':').map(Number);
          const totalMinutes = h * 60 + m;
          if (totalMinutes <= lastMinutes) {
            return false; // Not strictly ascending
          }
          lastMinutes = totalMinutes;
          if (!p.subject.trim()) {
            return false; // Subject can't be empty
          }
        }
      }
      return true;
    }

    // Save timetable to DB
    saveBtn.onclick = () => {
      validationMsg.textContent = '';
      if (!validateTimetable()) {
        validationMsg.textContent = 'Timetable invalid: check period times and subject names!';
        return;
      }
      database.ref(`users/${currentUser.uid}/timetable`).set(timetable)
        .then(() => alert('Timetable saved!'))
        .catch(e => alert('Save failed: ' + e.message));
    };

    // Auto-fill default timetable
    autoFillBtn.onclick = () => {
      days.forEach(day => {
        timetable[day] = JSON.parse(JSON.stringify(defaultPeriods));
      });
      renderTimetable();
      validationMsg.textContent = '';
    };

    // Find closest upcoming period for countdown
    function findClosestPeriod() {
      const now = new Date();
      const dayIndex = now.getDay() - 1; // Mon=1, Sun=0
      if (dayIndex < 0 || dayIndex >= days.length) {
        return null; // Weekend no periods
      }
      const dayName = days[dayIndex];
      const periods = timetable[dayName];
      if (!periods) return null;

      const nowMinutes = now.getHours() * 60 + now.getMinutes();

      let closest = null;
      let minDiff = Infinity;

      for (let i = 0; i < periods.length; i++) {
        const [h, m] = periods[i].startTime.split(':').map(Number);
        const periodMinutes = h * 60 + m;
        const diff = periodMinutes - nowMinutes;
        if (diff >= 0 && diff < minDiff) {
          minDiff = diff;
          closest = { day: dayName, periodIndex: i, subject: periods[i].subject, startTime: periods[i].startTime };
        }
      }
      return closest;
    }

    // Format time difference as hh:mm:ss
    function formatDiff(ms) {
      const totalSec = Math.floor(ms / 1000);
      const h = String(Math.floor(totalSec / 3600)).padStart(2, '0');
      const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
      const s = String(totalSec % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    // Countdown timer
    function startCountdown() {
      if (countdownInterval) clearInterval(countdownInterval);

      countdownInterval = setInterval(() => {
        if (!currentUser) {
          countdownDiv.textContent = '';
          clearInterval(countdownInterval);
          return;
        }
        const closest = findClosestPeriod();
        if (!closest) {
          countdownDiv.textContent = 'No upcoming periods today.';
          return;
        }
        const now = new Date();
        const [h, m] = closest.startTime.split(':').map(Number);
        const target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);

        let diffMs = target - now;
        if (diffMs < 0) diffMs = 0;

        countdownDiv.textContent = `Next: ${closest.subject} (${closest.day} Period ${closest.periodIndex + 1}) starts in ${formatDiff(diffMs)}`;
      }, 1000);
    }
  </script>
</body>
</html>
